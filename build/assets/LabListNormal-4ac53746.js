import{r,b as i,y as s,j as n,a as t,F as E}from"./index-3a453257.js";import te from"./MessagesList-b166e538.js";const p="https://backend.onrequestlab.com/api/v1",ce=()=>{const[M,R]=r.useState([]),[K,S]=r.useState(!1),[q,h]=r.useState(!1),[m,D]=r.useState(""),[ae,O]=r.useState(""),[l,X]=r.useState(""),[f,V]=r.useState(""),[g,I]=r.useState(1),[H,C]=r.useState(!1),[d,L]=r.useState({open:!1}),[U,x]=r.useState({open:!1}),[w,_]=r.useState(""),[v,$]=r.useState(""),N=5,b=e=>{var o;const c=`; ${document.cookie}`.split(`; ${e}=`);return c.length===2&&((o=c.pop())==null?void 0:o.split(";").shift())||""},y=b("user_id");r.useEffect(()=>{const e=b("access");X(e||"")},[]),r.useEffect(()=>{l&&k()},[l]);const k=async()=>{S(!0);try{let a=(await i.get(`${p}/lab/userinst/${y}/`,{headers:{Authorization:`Bearer ${l}`}})).data||[];a=a.sort((c,o)=>c.status==="Launched"&&o.status!=="Launched"?-1:c.status!=="Launched"&&o.status==="Launched"?1:0),R(a)}catch(e){console.error("Fetch instances error:",e.response||e),s.error("Failed to fetch instances")}finally{S(!1)}};r.useEffect(()=>{const e=localStorage.getItem("paymentSuccess"),a=localStorage.getItem("selectedType");e&&a&&(s.success("Payment verified! You can now launch your instance."),C(!0))},[]);const Y=async()=>{const e=localStorage.getItem("selectedType");if(!e)return s.error("No instance type found");await T(e),localStorage.removeItem("paymentSuccess"),localStorage.removeItem("selectedType"),C(!1)},G=()=>new Promise(e=>{const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.onload=()=>e(!0),a.onerror=()=>e(!1),document.body.appendChild(a)}),P=async e=>{if(!m){s.error("Please select instance type first");return}O(e),e==="free"?await T(m):await J(m,100)},J=async(e,a)=>{if(!await G())return s.error("Failed to load Razorpay");try{const o=await i.post(`${p}/users/create-order/`,{amount:a},{headers:{Authorization:`Bearer ${l}`}}),u={key:o.data.key_id,order_id:o.data.order_id,amount:a*100,name:"OnRequestLab",description:"Instance Payment",handler:async ee=>{try{(await i.post(`${p}/users/verify-payment/`,ee,{headers:{Authorization:`Bearer ${l}`}})).data.success?(s.success("Payment successful!"),localStorage.setItem("paymentSuccess","true"),localStorage.setItem("selectedType",e),window.location.href="/apps/LabListNormal"):s.error("Payment verification failed")}catch{s.error("Error verifying payment")}},modal:{ondismiss:()=>s.warning("Payment cancelled")},prefill:{name:"User",email:"user@example.com"}};new window.Razorpay(u).open()}catch{s.error("Error creating Razorpay order")}},T=async(e,a)=>{h(!0);try{await i.post(`${p}/users/deploy-experimental/linux/`,{action:e,user_id:y,payment_id:a},{headers:{Authorization:`Bearer ${l}`}}),s.info("Launching instance...");const c=setInterval(async()=>{const u=(await i.get(`${p}/lab/userinst/${y}/`,{headers:{Authorization:`Bearer ${l}`}})).data.find(B=>B.status==="Launched");u&&(clearInterval(c),s.success(`Instance launched at ${u.instance_ip}`),h(!1),k())},5e3)}catch{s.error("Instance launch failed"),h(!1)}},Q=async e=>{if(window.confirm("Are you sure to destroy this instance?"))try{h(!0),await i.post(`${p}/users/deploy/destroy/`,{user_id:e},{headers:{Authorization:`Bearer ${l}`}});const a=setInterval(async()=>{(await i.get(`${p}/lab/userinst/${y}/`,{headers:{Authorization:`Bearer ${l}`}})).data.find(u=>u.user_instance_id===e&&u.status!=="Terminated")||(clearInterval(a),s.success("Instance destroyed successfully!"),k(),h(!1))},2e3)}catch{s.error("Failed to destroy instance"),h(!1)}},W=async e=>{if(window.confirm("Are you sure you want to reboot this instance?"))try{const a=(localStorage.getItem("jwt-auth")||"").trim();if(!a)return s.error("No access token found. Please login again.");const c=b("csrftoken"),o=await i.post(`https://backend.onrequestlab.com/api/v1/users/reboot/${e}/`,{},{headers:{Authorization:`Bearer ${a}`,...c?{"X-CSRFTOKEN":c}:{},Accept:"application/json"}});s.success(o.data.message||"Reboot initiated!")}catch(a){console.error("Reboot error:",a.response||a),s.error("Failed to reboot instance")}},Z=async()=>{if(!w||!v)return s.error("Fill all fields");try{const e=b("csrftoken");await i.post("https://backend.onrequestlab.com/api/feedback/feedback_vc/",{user:y,description:v,subject:w},{headers:{Authorization:`Bearer ${l}`,...e?{"X-CSRFTOKEN":e}:{}}}),s.success("Feedback sent!"),x({open:!1}),_(""),$("")}catch{s.error("Failed to send feedback")}},A=e=>{navigator.clipboard.writeText(e),s.success("Copied to clipboard")},z=M.filter(e=>e.instance_type.toLowerCase().includes(f.toLowerCase())||e.status.toLowerCase().includes(f.toLowerCase())),F=Math.ceil(z.length/N),j=z.slice((g-1)*N,g*N);return n("div",{className:"p-6",children:[t("h2",{className:"text-2xl font-semibold mb-4",children:"Lab Manager"}),n("div",{className:"mb-4 flex flex-wrap gap-2 items-center",children:[n("select",{className:"border px-2 py-1 rounded",value:m,onChange:e=>D(e.target.value),children:[t("option",{value:"",children:"Select Instance Type"}),t("option",{value:"linux",children:"Pacemaker ClusterLab"}),t("option",{value:"redhat",children:"Iscsi Lab"})]}),t("button",{className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded",onClick:()=>P("paid"),children:"Pay"}),t("button",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded",onClick:()=>P("free"),children:"Launch Free Instance"}),t("input",{type:"text",placeholder:"Search by type/status...",className:"border px-2 py-1 rounded ml-2",value:f,onChange:e=>{V(e.target.value),I(1)}})]}),H&&t("div",{className:"mb-4",children:t("button",{className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded",onClick:Y,children:"Launch Instance (After Payment)"})}),n("table",{className:"min-w-full bg-white border rounded shadow",children:[t("thead",{children:n("tr",{className:"bg-gray-100 text-left",children:[t("th",{className:"py-2 px-3",children:"ID"}),t("th",{className:"py-2 px-3",children:"Type"}),t("th",{className:"py-2 px-3",children:"IP"}),t("th",{className:"py-2 px-3",children:"Status"}),t("th",{className:"py-2 px-3",children:"Actions"})]})}),t("tbody",{children:K?t("tr",{children:t("td",{colSpan:5,className:"text-center py-4",children:"Loading..."})}):j.length===0?t("tr",{children:t("td",{colSpan:5,className:"text-center py-4",children:"No instances"})}):j.map(e=>n("tr",{className:"border-t hover:bg-gray-50",children:[t("td",{className:"py-2 px-3",children:e.user_instance_id}),t("td",{className:"py-2 px-3",children:e.instance_type}),t("td",{className:"py-2 px-3",children:e.instance_ip||"-"}),t("td",{className:"py-2 px-3",children:e.status}),n("td",{className:"py-2 px-3 flex gap-2",children:[e.web_ssh_url&&n(E,{children:[t("button",{className:`px-2 py-1 rounded text-white ${e.status==="Terminated"?"bg-gray-400 cursor-not-allowed":"bg-yellow-500 hover:bg-yellow-600"}`,disabled:e.status==="Terminated",onClick:()=>e.status!=="Terminated"&&window.open(e.web_ssh_url,"_blank"),children:"SSH"}),t("button",{className:"px-2 py-1 rounded text-white bg-indigo-500 hover:bg-indigo-600",onClick:()=>L({open:!0,dp:e.AccessKeyId,secret:e.SecretAccessKey}),children:"View"})]}),e.status==="Launched"&&n(E,{children:[t("button",{className:"px-2 py-1 rounded text-white bg-blue-500 hover:bg-blue-600",onClick:()=>W(e.user_instance_id),children:"Reboot"}),t("button",{className:"px-2 py-1 rounded text-white bg-red-500 hover:bg-red-600",onClick:()=>Q(e.userId),children:"Destroy"}),t("button",{className:"px-2 py-1 rounded text-white bg-purple-500 hover:bg-purple-600",onClick:()=>x({open:!0,instanceId:e.user_instance_id}),children:"Feedback"})]})]})]},e.user_instance_id))})]}),F>1&&t("div",{className:"mt-4 flex gap-2 justify-center",children:Array.from({length:F},(e,a)=>t("button",{className:`px-3 py-1 rounded ${g===a+1?"bg-blue-600 text-white":"bg-gray-200 hover:bg-gray-300"}`,onClick:()=>I(a+1),children:a+1},a))}),q&&n("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50",children:[t("div",{className:"w-16 h-16 border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"}),t("p",{className:"text-white text-lg mt-4",children:"Processing..."})]}),d.open&&t("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4",children:n("div",{className:"bg-white rounded p-6 w-full max-w-2xl max-h-[80vh] relative overflow-y-auto",children:[t("h3",{className:"text-lg font-semibold mb-4",children:"Instance Keys"}),n("div",{className:"mb-2 flex justify-between items-center break-all",children:[t("span",{className:"font-semibold",children:"DP Key:"}),n("div",{className:"flex gap-2 flex-1 ml-2",children:[t("span",{className:"font-mono truncate",children:d.dp||"-"}),d.dp&&t("button",{className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300",onClick:()=>A(d.dp),children:"Copy"})]})]}),n("div",{className:"mb-4 flex justify-between items-center break-all",children:[t("span",{className:"font-semibold",children:"Secret Key:"}),n("div",{className:"flex gap-2 flex-1 ml-2",children:[t("span",{className:"font-mono truncate",children:d.secret||"-"}),d.secret&&t("button",{className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300",onClick:()=>A(d.secret),children:"Copy"})]})]}),t("button",{className:"absolute top-2 right-2 text-gray-600 hover:text-gray-900",onClick:()=>L({open:!1}),children:"X"})]})}),U.open&&t("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50",children:n("div",{className:"bg-white rounded p-6 w-96 relative",children:[t("h3",{className:"text-lg font-semibold mb-4",children:"Send Feedback"}),t("input",{type:"text",placeholder:"Subject",className:"border px-2 py-1 w-full mb-2 rounded",value:w,onChange:e=>_(e.target.value)}),t("textarea",{placeholder:"Message",className:"border px-2 py-1 w-full mb-2 rounded",value:v,onChange:e=>$(e.target.value)}),n("div",{className:"flex justify-end gap-2",children:[t("button",{className:"px-4 py-2 bg-gray-200 rounded hover:bg-gray-300",onClick:()=>x({open:!1}),children:"Cancel"}),t("button",{className:"px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600",onClick:Z,children:"Send"})]})]})}),t(te,{})]})};export{ce as default};
