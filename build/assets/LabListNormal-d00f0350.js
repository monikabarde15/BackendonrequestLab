import{r as c,b as h,y as a,j as i,a as t,F as V}from"./index-e4a951c8.js";import ce from"./MessagesList-d6ccd5bd.js";const u="https://backend.onrequestlab.com/api/v1",ue=()=>{const[J,z]=c.useState([]),[b,w]=c.useState([]),[W,A]=c.useState(!1),[ie,N]=c.useState(!1),[l,U]=c.useState(""),[g,X]=c.useState(""),[x,G]=c.useState(""),[n,Q]=c.useState(""),[S,Y]=c.useState(""),[k,R]=c.useState(1),[_,j]=c.useState(null),[$,T]=c.useState({open:!1}),[Z,C]=c.useState({open:!1}),[I,B]=c.useState(""),[L,M]=c.useState(""),P=5,E=e=>{var o;if(typeof document>"u")return"";const s=`; ${document.cookie}`.split(`; ${e}=`);return s.length===2&&((o=s.pop())==null?void 0:o.split(";").shift())||""},f=E("user_id");c.useEffect(()=>{const e=E("access"),r=localStorage.getItem("jwt-auth")||localStorage.getItem("access"),s=(e||r||"").trim();Q(s)},[]),c.useEffect(()=>{n&&F()},[n]),c.useEffect(()=>{const e=localStorage.getItem("payments");e&&w(JSON.parse(e))},[]),c.useEffect(()=>{localStorage.setItem("payments",JSON.stringify(b))},[b]);const F=async()=>{if(n){A(!0);try{let r=(await h.get(`${u}/lab/userinst/${f}/`,{headers:{Authorization:`Bearer ${n}`}})).data||[];r.sort((s,o)=>s.status==="Launched"&&o.status!=="Launched"?-1:o.status==="Launched"&&s.status!=="Launched"?1:0),z(r)}catch(e){console.error("Fetch instances error:",(e==null?void 0:e.response)||e),a.error("Failed to fetch instances")}finally{A(!1)}}},ee=()=>new Promise(e=>{if(typeof document>"u")return e(!1);if(document.querySelector('script[src="https://checkout.razorpay.com/v1/checkout.js"]'))return e(!0);const s=document.createElement("script");s.src="https://checkout.razorpay.com/v1/checkout.js",s.onload=()=>e(!0),s.onerror=()=>e(!1),document.body.appendChild(s)}),te=e=>{switch(e){case"linux":return"linux";case"iscsi":return"iscsi";case"redhat":return"redhat";default:return""}},re=async e=>{if(!n)return a.error("No access token available");if(e==="free"){if(!g)return a.error("Select free instance type");await K(g,"free")}else{if(!x)return a.error("Select paid instance type");await ae(x)}},ae=async e=>{if(!n)return a.error("No access token available");if(!await ee())return a.error("Failed to load Razorpay");try{const s=await h.post(`${u}/users/create-order/`,{amount:100},{headers:{Authorization:`Bearer ${n}`}}),o={key:s.data.key_id,order_id:s.data.order_id,amount:100*100,name:"OnRequestLab",description:"Instance Payment",handler:async d=>{try{if((await h.post(`${u}/users/verify-payment/`,d,{headers:{Authorization:`Bearer ${n}`}})).data.success){a.success("Payment successful!");const y={payment_id:d.razorpay_payment_id,type:e,amount:100,refunded:!1};w(v=>[...v,y]),j(d.razorpay_payment_id),await K(e,d.razorpay_payment_id),F()}else a.error("Payment verification failed")}catch(m){console.error("Verify payment error:",m),a.error("Error verifying payment")}},modal:{ondismiss:()=>a.warning("Payment cancelled")},prefill:{name:"User",email:"user@example.com"}};new window.Razorpay(o).open()}catch(s){console.error("Create order error:",s),a.error("Error creating Razorpay order")}},K=async(e,r)=>{if(n){N(!0);try{const s=l==="free"?`${u}/users/deploy-free/${te(e)}/`:`${u}/users/deploy/${e}/`;await h.post(s,{user_id:f,payment_id:r==="free"?void 0:r,action:e},{headers:{Authorization:`Bearer ${n}`}}),a.info("Launching instance...");const o=setInterval(async()=>{try{const d=(await h.get(`${u}/lab/userinst/${f}/`,{headers:{Authorization:`Bearer ${n}`}})).data||[];d.sort((y,v)=>y.status==="Launched"&&v.status!=="Launched"?-1:v.status==="Launched"&&y.status!=="Launched"?1:0),z(d);const m=d.find(y=>y.status==="Launched"&&(r==="free"||y.payment_id===r));m&&(clearInterval(o),a.success(`Instance launched: ${m.instance_ip||m.user_instance_id}`),N(!1))}catch(p){console.error("Polling launch status error:",p)}},3e3)}catch(s){console.error("Launch instance error:",s),a.error("Instance launch failed"),N(!1)}}},q=async e=>{var r,s;if(!n)return a.error("No access token available");if(window.confirm("Are you sure you want to request a refund for this payment?"))try{const o=await h.post(`${u}/users/refund-payment/`,{payment_id:e},{headers:{Authorization:`Bearer ${n}`}});(r=o.data)!=null&&r.success?(a.success("Refund successful!"),w(p=>p.map(d=>d.payment_id===e?{...d,refunded:!0}:d)),j(null)):a.info(((s=o.data)==null?void 0:s.message)||"Refund request submitted")}catch(o){console.error("Refund error:",(o==null?void 0:o.response)||o),a.error("Failed to process refund")}},se=async e=>{if(!n)return a.error("No access token available");if(window.confirm("Are you sure you want to reboot this instance?"))try{await h.post(`${u}/users/reboot/${e}/`,{},{headers:{Authorization:`Bearer ${n}`}}),a.success("Reboot initiated!")}catch(r){console.error("Reboot error:",(r==null?void 0:r.response)||r),a.error("Failed to reboot instance")}},ne=async e=>{if(!n)return a.error("No access token available");if(window.confirm("Are you sure to destroy this instance?"))try{e.payment_id?await h.post(`${u}/users/deploy-experimental/destroy/`,{user_id:e.user_instance_id},{headers:{Authorization:`Bearer ${n}`}}):await h.post(`${u}/users/deploy-free/destroy/`,{user_id:e.user_instance_id},{headers:{Authorization:`Bearer ${n}`}}),a.success("Destroy request sent"),setTimeout(F,3e3)}catch(r){console.error("Destroy instance error:",r),a.error("Failed to destroy instance")}},oe=async()=>{if(!n)return a.error("No access token available");if(!I||!L)return a.error("Fill all fields");try{await h.post(`${u}/feedback/feedback_vc/`,{user:f,subject:I,description:L},{headers:{Authorization:`Bearer ${n}`}}),a.success("Feedback sent!"),C({open:!1}),B(""),M("")}catch(e){console.error("Feedback error:",e),a.error("Failed to send feedback")}},D=J.filter(e=>(e.instance_type||"").toLowerCase().includes(S.toLowerCase())||(e.status||"").toLowerCase().includes(S.toLowerCase())),H=Math.ceil(D.length/P),O=D.slice((k-1)*P,k*P);return i("div",{className:"p-6",children:[t("h2",{className:"text-2xl font-semibold mb-4",children:"Lab Manager"}),i("div",{className:"mb-4 flex flex-wrap gap-2 items-center",children:[i("select",{className:"border px-2 py-1 rounded",value:l,onChange:e=>U(e.target.value),children:[t("option",{value:"",children:"Select Plan"}),t("option",{value:"free",children:"Free"}),t("option",{value:"paid",children:"Paid"})]}),l==="free"&&i("select",{className:"border px-2 py-1 rounded",value:g,onChange:e=>X(e.target.value),children:[t("option",{value:"",children:"Select Free Instance"}),t("option",{value:"linux",children:"Linux (1 bare-metal instance, 1 hour)"}),t("option",{value:"iscsi",children:"iSCSI (2 bare-metal instances: iscsiserver & iscsiclient, 1 hour)"}),t("option",{value:"redhat",children:"RedHat (3 AWS instances: nodea, nodeb & nodec, 1 hour)"})]}),l==="paid"&&i("select",{className:"border px-2 py-1 rounded",value:x,onChange:e=>G(e.target.value),children:[t("option",{value:"",children:"Select Paid Instance"}),t("option",{value:"linux",children:"Linux (1 bare-metal, 8 hours)"}),t("option",{value:"iscsi",children:"iSCSI (2 bare-metal: iscsiserver & iscsiclient, 3 hours)"}),t("option",{value:"redhat",children:"RedHat (3 AWS nodes: nodea, nodeb & nodec, 3 hours)"})]}),t("button",{className:`px-4 py-1 rounded text-white ${l==="free"?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700"}`,onClick:()=>re(l),disabled:l===""||l==="free"&&g===""||l==="paid"&&x==="",children:l==="free"?"Launch Free":"Pay"}),_&&l==="paid"&&(()=>{const e=b.find(r=>r.payment_id===_);return e&&!e.refunded?t("button",{className:"px-4 py-1 rounded text-white bg-orange-500 hover:bg-orange-600",onClick:()=>q(_),children:"Refund"}):null})(),t("input",{type:"text",placeholder:"Search by type/status...",className:"border px-2 py-1 rounded ml-2",value:S,onChange:e=>{Y(e.target.value),R(1)}})]}),i("table",{className:"min-w-full bg-white border rounded shadow",children:[t("thead",{children:i("tr",{className:"bg-gray-100 text-left",children:[t("th",{className:"py-2 px-3",children:"ID"}),t("th",{className:"py-2 px-3",children:"Type"}),t("th",{className:"py-2 px-3",children:"IP"}),t("th",{className:"py-2 px-3",children:"Status"}),t("th",{className:"py-2 px-3",children:"Actions"})]})}),t("tbody",{children:W?t("tr",{children:t("td",{colSpan:5,className:"text-center py-4",children:"Loading..."})}):O.length===0?t("tr",{children:t("td",{colSpan:5,className:"text-center py-4",children:"No instances"})}):O.map(e=>{const r=e.payment_id||e.order_id,s=b.find(d=>d.payment_id===r),o=e.dp_key||e.AccessKeyId||"",p=e.secret_key||e.SecretAccessKey||"";return i("tr",{className:"border-t hover:bg-gray-50",children:[t("td",{className:"py-2 px-3",children:e.user_instance_id}),t("td",{className:"py-2 px-3",children:e.instance_type}),t("td",{className:"py-2 px-3",children:e.instance_ip||"-"}),t("td",{className:"py-2 px-3",children:e.status}),i("td",{className:"py-2 px-3 flex gap-2",children:[r&&e.status==="Launched"&&s&&!s.refunded&&t("button",{className:"px-2 py-1 rounded text-white bg-orange-500 hover:bg-orange-600",onClick:()=>q(r),children:"Refund"}),e.web_ssh_url&&i(V,{children:[t("button",{className:`px-2 py-1 rounded text-white ${e.status==="Terminated"?"bg-gray-400 cursor-not-allowed":"bg-yellow-500 hover:bg-yellow-600"}`,disabled:e.status==="Terminated",onClick:()=>e.status!=="Terminated"&&window.open(`/lab?user=${f}`,"_blank"),children:"SSH"}),t("button",{className:"px-2 py-1 rounded text-white bg-indigo-500 hover:bg-indigo-600",onClick:()=>T({open:!0,dp:o,secret:p}),children:"View"})]}),e.status==="Launched"&&i(V,{children:[t("button",{className:"px-2 py-1 rounded text-white bg-blue-500 hover:bg-blue-600",onClick:()=>se(e.user_instance_id),children:"Reboot"}),t("button",{className:"px-2 py-1 rounded text-white bg-red-500 hover:bg-red-600",onClick:()=>ne(e),children:"Destroy"}),t("button",{className:"px-2 py-1 rounded text-white bg-purple-500 hover:bg-purple-600",onClick:()=>C({open:!0,instanceId:e.user_instance_id}),children:"Feedback"})]})]})]},e.user_instance_id)})})]}),H>1&&t("div",{className:"mt-4 flex gap-2 justify-center",children:Array.from({length:H},(e,r)=>t("button",{className:`px-3 py-1 rounded ${k===r+1?"bg-blue-600 text-white":"bg-gray-200"}`,onClick:()=>R(r+1),children:r+1},r))}),$.open&&t("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:i("div",{className:"bg-white p-4 rounded shadow w-96 relative",children:[t("h3",{className:"text-lg font-semibold mb-2",children:"Keys"}),i("div",{className:"mb-2",children:[t("strong",{children:"DP / Access Key:"})," ",$.dp]}),i("div",{className:"mb-2",children:[t("strong",{children:"Secret Key:"})," ",$.secret]}),t("button",{className:"absolute top-2 right-2 text-red-600 font-bold",onClick:()=>T({open:!1}),children:"X"})]})}),Z.open&&t("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:i("div",{className:"bg-white p-4 rounded shadow w-96 relative",children:[t("h3",{className:"text-lg font-semibold mb-2",children:"Feedback"}),t("input",{type:"text",placeholder:"Subject",className:"w-full border px-2 py-1 mb-2 rounded",value:I,onChange:e=>B(e.target.value)}),t("textarea",{placeholder:"Message",className:"w-full border px-2 py-1 mb-2 rounded",value:L,onChange:e=>M(e.target.value)}),i("div",{className:"flex justify-end gap-2",children:[t("button",{className:"px-3 py-1 rounded bg-gray-300 hover:bg-gray-400",onClick:()=>C({open:!1}),children:"Cancel"}),t("button",{className:"px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white",onClick:oe,children:"Send"})]})]})}),t(ce,{})]})};export{ue as default};
